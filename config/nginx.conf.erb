##########################################################################
#  Learn more about using the Nginx configuration template at:
#  https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template
#
#  *** NOTE ***
#  If you customize the template file, make sure you keep an eye on the
#  original template file and merge any changes. New Phusion Passenger
#  features may require changes to the template file.
##############################################################

<%= include_passenger_internal_template('global.erb') %>

worker_processes 1;
events {
worker_connections 4096;
}

http {
<%= include_passenger_internal_template('http.erb', 4) %>

### BEGIN your own configuration options ###
# This is a good place to put your own config
# options. Note that your options must not
# conflict with the ones Passenger already sets.
# Learn more at:
# https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template

passenger_min_instances 12;
passenger_max_pool_size 16;

log_format escaped_log escape=json '["$status","$host","$time_iso8601","$http_x_forwarded_for","$request_time","$upstream_response_time","$http_user_agent","$http_referer","$request"]';

### END your own configuration options ###

default_type application/octet-stream;
types_hash_max_size 2048;
server_names_hash_bucket_size 64;
client_max_body_size 1024m;
access_log off;
keepalive_timeout 60;
underscores_in_headers on;
gzip on;
gzip_comp_level 3;
gzip_min_length 150;
gzip_proxied any;
gzip_types text/plain text/css text/json text/javascript
application/javascript application/x-javascript application/json
application/rss+xml application/vnd.ms-fontobject application/x-font-ttf
application/xml font/opentype image/svg+xml text/xml;

<% for app in @apps %>
  server {
  access_log /home/ubuntu/timetracker/log/nginx.log escaped_log;

  <%= include_passenger_internal_template('server.erb', 8, true, binding) %>

  # Rails asset pipeline & webpacker support.
  location ~ "^/(assets|packs)/.+-([0-9a-f]{32}|[0-9a-f]{64}|[0-9a-f]{20})\..+" {
  error_page 490 = @static_asset;
  error_page 491 = @dynamic_request;
  recursive_error_pages on;

  if (-f $request_filename) {
  return 490;
  }
  if (!-f $request_filename) {
  return 491;
  }
  }
  location @static_asset {
  gzip_static on;
  expires max;
  add_header Cache-Control public;
  add_header ETag "";
  add_header "Access-Control-Allow-Origin" "*";
  add_header "Access-Control-Allow-Methods" "POST, GET, OPTIONS";
  }
  location @dynamic_request {
  passenger_enabled on;
  add_header "Access-Control-Allow-Origin" "*";
  add_header "Access-Control-Allow-Methods" "POST, GET, OPTIONS";
  }

  ### BEGIN your own configuration options ###
  # This is a good place to put your own config
  # options. Note that your options must not
  # conflict with the ones Passenger already sets.
  # Learn more at:
  # https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template
  error_page 503 /503_standalone.html;

  ### END your own configuration options ###
  }
  passenger_pre_start <%= listen_url(app) %>;
<% end %>

<%= include_passenger_internal_template('footer.erb', 4) %>
}
